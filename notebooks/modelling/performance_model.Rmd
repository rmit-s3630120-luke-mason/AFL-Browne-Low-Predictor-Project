---
title: "AFL Modelling of Performance Per Game"
output: html_notebook
---
```{r}
source("../../utilities/DBDA2E-utilities.R")
source("../../utilities/MoreUtilities.R")
library(ggplot2)
library(ggpubr)
library(ks)
library(rjags)
library(runjags)
library(benchmarkme)
```

## Read train and test sets from files.
```{r}
train <- read.csv("../../data/train_performance.csv")
test <- read.csv("../../data/test_performance.csv")
performance <- read.csv("../../data/performance.csv")
```

# Modelling
```{r}
colnames(train[,1:22])
y <- train$Brownlow.Votes
x <- as.matrix(train[,1:22])
xPred = as.matrix(test[,1:22])

dataList = list(
  x = x,
  colCount = ncol(x), 
  
  y = y,
  rowCount = length(y),
  
  xPred = xPred,
  predCount = nrow(xPred)
)

summary(x)
```



### JAGS Model
```{r}
	modelString = "
	data {
	  yMean <- mean(y)
	  
	  # There was no expert information and because we have a lot of data, we 
	  # made the variances very high and mu = 0 so that the model can converge 
	  # without priors effecting the results much.
	  mu0 <- yMean
	  for (i in 1:colCount) {
	    mu[i] <- 0
	  }
	  
	  Var0   <- 1000 # Set simply to 1
	  for (i in 1:colCount) {
	    Var[i] <- 1000
	  }
	}
	
	# Model
	model {
	  beta0   ~ dnorm(mu0,  1/Var0)
	  for (j in 1:colCount) {
	    beta[j] ~ dnorm(mu[j], 1/Var[j])
	  }
	  
	  precision ~ dexp(1/0.25) 
	  
	  for (i in 1:rowCount) {
	  
	    # Normal Likelihood
	    y[i] ~ dnorm(beta0 + sum(beta[1:colCount]*x[i,1:colCount]), precision)
	  }

    for (k in 1:predCount) {
      pred[k] <- beta0 + sum(beta[1:colCount]*xPred[k,1:colCount])
    }
}
"
	
	writeLines(modelString, con="TEMPmodel2.txt")
```
### Run JAGS
```{r}

parameters = c("beta0")
for ( i in 1:22){
  parameters = c(parameters, paste0("beta[",i,"]"))
}
for ( i in 1:nrow(xPred)){
  parameters = c(parameters, paste0("pred[",i,"]"))
}

adaptSteps = 50
burnInSteps = 100
nChains = 2
thinSteps = 17
numSavedSteps = 250

nIter = ceiling( ( numSavedSteps * thinSteps ) / nChains )

startTime = proc.time()
# sink("debug2.txt")
runJagsOut <- run.jags( method="parallel" ,
                        model="TEMPmodel2.txt",
                        monitor=parameters,
                        data=dataList,
                        n.chains=nChains,
                        adapt=adaptSteps,
                        burnin=burnInSteps,
                        sample=numSavedSteps,
                        thin=thinSteps , summarise=FALSE , plots=FALSE )
stopTime = proc.time()
duration = stopTime - startTime
show(duration)
codaSamples = as.mcmc.list( runJagsOut )
# sink()
save( codaSamples , file=paste("Run1","Mcmc.Rdata",sep="") )
save.image(file='Run1.RData')
```

### Results
```{r}

# ============= Display Results ============
diagMCMC( codaSamples , parName="beta0" )
for ( i in 1:22){
  diagMCMC( codaSamples , parName=paste0("beta[",i,"]") )
}

compVal <- data.frame(
  "beta0" = 0, 
  "beta[1]" = 0,
  "beta[2]" = 0, 
  "beta[3]" = 0, 
  "beta[4]" =  0, 
  "beta[5]" =  0,
  "beta[6]" =  0,
  "beta[7]" =  0,
  "beta[8]" =  0,
  "beta[9]" =  0,
  "beta[10]" =  0,
  "beta[11]" =  0,
  "beta[12]" =  0,
  "beta[13]" =  0,
  "beta[14]" =  0,
  "beta[15]" =  0,
  "beta[16]" =  0,
  "beta[17]" =  0,
  "beta[18]" =  0,
  "beta[19]" =  0,
  "beta[20]" =  0,
  "beta[21]" =  0,
  "beta[22]" =  0,
  check.names=FALSE)


summaryInfo <- smryMCMC( codaSamples = codaSamples , compVal = compVal, saveName="SummaryInfo" )


plotMCMC_HD( codaSamples = codaSamples, data = performance, xName=c(
  "Disposals",
  "Kicks",
  "Marks",
  "Handballs",
  "Goals",
  "Behinds",
  "Hit.Outs",
  "Tackles",
  "Rebounds",
  "Inside.50s",
  "Clearances",
  "Clangers",
  "Frees",
  "Frees.Against",
  "Contested.Possessions",
  "Uncontested.Possessions",
  "Contested.Marks",
  "Marks.Inside.50",
  "One.Percenters",
  "Bounces",
  "Goal.Assists",
  "X..Played"
 ),
 yName="Brownlow.Votes", compVal = compVal, preds = TRUE)

```

# ============ Predictive check ============
```{r}
# modes = summaryInfo[,"Mode"]
# # 14 is the number of rows skipping beta and heading rows = (6 + 5 + 2)
# predictions = modes[13:length(modes) - 1]
# real = c(test$SalePrice.100K.)
# length(predictions)
# length(real)
# n = length(real)
# # MAE
# sum(abs(predictions - real))/n
# # MSE
# mse = sum((real - predictions)^2)
# mse
# # RMSE
# sqrt(mse/n)

failed.JAGS("model")
```
